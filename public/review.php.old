<?php
require_once('../config/db.php');

$statusFilter = $_GET['status'] ?? 'new';

// Fetch categories once
$categories = $pdo->query("SELECT id, name FROM categories ORDER BY name")->fetchAll(PDO::FETCH_ASSOC);

// Fetch staging rows with matched transaction details
$filterSql = "
    SELECT s.*, a.name AS account_name, a.type AS account_type,
           t.date AS match_date, t.description AS match_desc,
           t.amount AS match_amt, t.type AS match_type, ac.name AS match_account
    FROM staging_transactions s
    JOIN accounts a ON s.account_id = a.id
    LEFT JOIN transactions t ON s.matched_transaction_id = t.id
    LEFT JOIN accounts ac ON t.account_id = ac.id
";

if ($statusFilter !== 'all') {
    $filterSql .= " WHERE s.status = ?";
    $stmt = $pdo->prepare($filterSql . " ORDER BY s.date ASC LIMIT 25");
    $stmt->execute([$statusFilter]);
} else {
    $stmt = $pdo->query($filterSql . " ORDER BY s.date ASC LIMIT 25");
}

$rows = $stmt->fetchAll();
?>

<!DOCTYPE html>
<html>
<head>
    <title>Review Transactions</title>
    <script>
    function submitAction(txnId, action, categoryId = null) {
        const formData = new FormData();
        formData.append('txn_id', txnId);
        formData.append('action', action);
        if (categoryId) formData.append('category_id', categoryId);

        fetch('review_actions.php', {
            method: 'POST',
            body: formData
        }).then(() => {
            location.reload();
        });
    }
    </script>
</head>
<body>
<h1>Review Transactions (<?= htmlspecialchars($statusFilter) ?>)</h1>

<nav>
  <a href="?status=new">New</a> |
  <a href="?status=potential_duplicate">Potential Duplicates</a> |
  <a href="?status=duplicate">Duplicates</a> |
  <a href="?status=all">All</a>
</nav>

<table border="1" cellpadding="5">
<tr>
    <th>Status</th>
    <th>Date</th>
    <th>Account</th>
    <th>Description</th>
    <th>Amount</th>
    <th>Memo</th>
    <th>Category</th>
    <th>Action</th>
    <th>Matched Transaction</th>
</tr>

<?php foreach ($rows as $txn): ?>
<tr>
    <td><?= htmlspecialchars($txn['status']) ?></td>
    <td><?= htmlspecialchars($txn['date']) ?></td>
    <td><?= htmlspecialchars($txn['account_name']) ?></td>
    <td><?= htmlspecialchars($txn['description']) ?></td>
    <td><?= htmlspecialchars($txn['amount']) ?></td>
    <td><?= htmlspecialchars($txn['original_memo']) ?></td>
    <td>
        <select id="category_<?= $txn['id'] ?>">
            <option value="">-- select --</option>
            <?php foreach ($categories as $cat): ?>
                <option value="<?= $cat['id'] ?>"><?= htmlspecialchars($cat['name']) ?></option>
            <?php endforeach; ?>
        </select>
    </td>
    <td>
        <?php if ($txn['status'] === 'potential_duplicate'): ?>
            <button onclick="submitAction(<?= $txn['id'] ?>, 'confirm_duplicate')">Confirm Match</button>
            <button onclick="submitAction(<?= $txn['id'] ?>, 'not_duplicate', document.getElementById('category_<?= $txn['id'] ?>').value)">Not a Match</button>
        <?php elseif ($txn['status'] === 'duplicate'): ?>
            <button onclick="submitAction(<?= $txn['id'] ?>, 'delete')">Delete</button>
        <?php else: ?>
            <button onclick="submitAction(<?= $txn['id'] ?>, 'approve', document.getElementById('category_<?= $txn['id'] ?>').value)">Approve</button>
            <button onclick="submitAction(<?= $txn['id'] ?>, 'delete')">Delete</button>
        <?php endif; ?>
    </td>
    <td>
        <?php if ($txn['match_date']): ?>
            <?= htmlspecialchars($txn['match_date']) ?><br>
            <?= htmlspecialchars($txn['match_desc']) ?><br>
            <?= htmlspecialchars($txn['match_amt']) ?><br>
            <?= htmlspecialchars($txn['match_type']) ?><br>
            <?= htmlspecialchars($txn['match_account']) ?>
        <?php endif; ?>
    </td>
</tr>
<?php endforeach; ?>
</table>
</body>
</html>
